<!DOCTYPE html>
<html>
<head>
    <title>Credentials Editor</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f5f5f5;
        }
        textarea { 
            width: 100%; 
            height: 300px; 
            margin-bottom: 10px; 
            font-family: monospace; 
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button { 
            padding: 10px 15px; 
            background: #2ea44f; 
            color: white; 
            border: none; 
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover {
            background: #22863a;
        }
        .message { 
            margin-top: 10px; 
            padding: 10px; 
            border-radius: 4px; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .error { 
            background: #f8d7da; 
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .login-form { 
            margin: 20px 0; 
            padding: 20px; 
            background: white; 
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>Credentials Editor</h1>
    
    <div id="loginForm" class="login-form">
        <h3>GitHub Authentication</h3>
        <p>You need to authenticate with GitHub to edit the credentials file:</p>
        <button id="loginBtn">
            <span id="loginText">Login with GitHub</span>
            <span id="loginSpinner" class="loading" style="display: none;"></span>
        </button>
    </div>
    
    <div id="editorSection" style="display: none;">
        <p><strong>Editing:</strong> credentials.json</p>
        <textarea id="jsonEditor" spellcheck="false"></textarea>
        <button id="saveBtn">
            <span id="saveText">Save Changes</span>
            <span id="saveSpinner" class="loading" style="display: none;"></span>
        </button>
        <div id="message" class="message" style="display: none;"></div>
    </div>

    <script>
        // GitHub OAuth App configuration
        const CLIENT_ID = 'Ov23liJW0Uo1XGptPC46';
        const REDIRECT_URI = window.location.href.split('?')[0];
        const REPO_OWNER = 'themdashraful2207';
        const REPO_NAME = 'civilapp';
        const FILE_PATH = 'credentials.json';
        
        // DOM elements
        const loginBtn = document.getElementById('loginBtn');
        const loginText = document.getElementById('loginText');
        const loginSpinner = document.getElementById('loginSpinner');
        const saveBtn = document.getElementById('saveBtn');
        const saveText = document.getElementById('saveText');
        const saveSpinner = document.getElementById('saveSpinner');
        
        // Check for OAuth callback
        if (window.location.search.includes('code=')) {
            handleOAuthCallback();
        } else {
            loginBtn.addEventListener('click', startOAuthFlow);
        }
        
        function showLoading(button, textElement, spinnerElement) {
            textElement.style.display = 'none';
            spinnerElement.style.display = 'inline-block';
            button.disabled = true;
        }
        
        function hideLoading(button, textElement, spinnerElement) {
            textElement.style.display = 'inline-block';
            spinnerElement.style.display = 'none';
            button.disabled = false;
        }
        
        function startOAuthFlow() {
            showLoading(loginBtn, loginText, loginSpinner);
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=repo`;
            window.location.href = authUrl;
        }
        
        async function handleOAuthCallback() {
            showLoading(loginBtn, loginText, loginSpinner);
            const code = new URLSearchParams(window.location.search).get('code');
            
            try {
                // In a production environment, you should exchange the code for a token via a backend service
                // For demo purposes, we'll use a proxy server or direct frontend implementation
                
                // Option 1: Use a proxy server (recommended for production)
                // const response = await fetch('https://your-proxy-server.com/exchange-code', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ code })
                // });
                // const { token } = await response.json();
                
                // Option 2: Direct frontend implementation (for demo only - not secure for production)
                const response = await fetch(`https://github.com/login/oauth/access_token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: CLIENT_ID,
                        client_secret: 'YOUR_CLIENT_SECRET', // Never expose this in frontend code!
                        code: code,
                        redirect_uri: REDIRECT_URI
                    })
                });
                
                if (!response.ok) throw new Error('Failed to get access token');
                
                const data = await response.json();
                const token = data.access_token;
                
                if (!token) throw new Error('No access token received');
                
                // Store token temporarily (in production, use secure HTTP-only cookies)
                sessionStorage.setItem('github_token', token);
                window.history.replaceState({}, document.title, REDIRECT_URI);
                
                await initEditor(token);
                
            } catch (error) {
                console.error('Authentication error:', error);
                showMessage(`Error: ${error.message}`, 'error');
                hideLoading(loginBtn, loginText, loginSpinner);
            }
        }
        
        async function initEditor(token) {
            hideLoading(loginBtn, loginText, loginSpinner);
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('editorSection').style.display = 'block';
            
            try {
                showLoading(saveBtn, saveText, saveSpinner);
                
                const response = await fetch(
                    `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
                    {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (!response.ok) throw new Error('Failed to fetch file');
                
                const data = await response.json();
                const content = atob(data.content.replace(/\s/g, ''));
                document.getElementById('jsonEditor').value = JSON.stringify(JSON.parse(content), null, 2);
                document.getElementById('jsonEditor').dataset.sha = data.sha;
                
                hideLoading(saveBtn, saveText, saveSpinner);
                
            } catch (error) {
                console.error('Editor initialization error:', error);
                showMessage(`Error: ${error.message}`, 'error');
                hideLoading(saveBtn, saveText, saveSpinner);
            }
            
            document.getElementById('saveBtn').addEventListener('click', () => saveChanges(token));
        }
        
        async function saveChanges(token) {
            const editor = document.getElementById('jsonEditor');
            const content = editor.value;
            const sha = editor.dataset.sha;
            
            try {
                showLoading(saveBtn, saveText, saveSpinner);
                
                // Validate JSON
                JSON.parse(content);
                
                const response = await fetch(
                    `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: 'Update credentials.json via web editor',
                            content: btoa(unescape(encodeURIComponent(content))),
                            sha: sha
                        })
                    }
                );
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update file');
                }
                
                const data = await response.json();
                showMessage('File updated successfully!', 'success');
                document.getElementById('jsonEditor').dataset.sha = data.content.sha;
                
            } catch (error) {
                console.error('Save error:', error);
                showMessage(`Error: ${error.message}`, 'error');
            } finally {
                hideLoading(saveBtn, saveText, saveSpinner);
            }
        }
        
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>
